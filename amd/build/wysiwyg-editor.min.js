define(["jquery","core/str","qtype_stack/tex2max.amd","qtype_stack/visual-math-input","qtype_stack/editor"],function(t,e,a,i,s){"use strict";var n=function(e,a,i,n,r){s.call(this,e,a,i,n,r),this.controls=null,this.lastFocusedInput={input:null},this.latexresponse=i.latexresponse,this.inputoptions=this._formatOptionsObj(i.inputoptions),this.delayTimeoutHandle=null,this.converter=null,this.visualMath=null,this.$wrapper=null,this.$debugFeedback=null,this.$latexInput=t("#"+t.escapeSelector(this.prefix+this.name)+"_latex"),this.lastMaximaRes=this.$stackInput.val(),this.lastLatex=this.$latexInput.val()?this.$latexInput.val():this.latexresponse,this._init()};return(n.prototype=Object.create(s.prototype)).constructor=n,n.prototype.EDITOR_NAME="WYSIWYG",n.prototype._init=function(){this.$stackInput.wrap("<div>"),this.$wrapper=this.$stackInput.parent().attr({class:"wysiwyg"}),this._addEventHandlers(),this._initTeX2Max(),this._initMathQuill(),this._isReadonly()||this._buildInputControls(this.editorOptions.mathinputmode)},n.prototype._buildInputControls=function(e){if(!e)throw new Error("No mathinputmode is set");var a=t("<div>").attr({class:"controls_wrapper"});this.$wrapper.prepend(a),this.controls=new i.ControlList(a,this.lastFocusedInput);var s=[];switch(e){case"simple":s=["sqrt","divide","pi","caret"],this.controls.enable(s);break;case"normal":s=["sqrt","divide","nchoosek","pi","caret"],this.controls.enable(s);break;case"advanced":this.controls.enableAll()}},n.prototype.DEFAULT_TEX2MAX_OPTIONS={onlySingleVariables:!1,handleEquation:!1,addTimesSign:!0,onlyGreekName:!0,onlyGreekSymbol:!1,debugging:!1},n.prototype.TYPINGDELAY=1e3,n.prototype._initTeX2Max=function(){try{this.converter=new a(this.inputoptions)}catch(t){this.$stackInput.trigger("valerror",[t.message])}},n.prototype._initMathQuill=function(){var t=this._restoreLatex(),e=this;this._isReadonly()?t&&(this.visualMath=new i.StaticInput(this.$stackInput,this.$wrapper),this.visualMath.$input.hide()):(this.visualMath=new i.Input(this.$stackInput,this.$wrapper,this.lastFocusedInput),e.visualMath.onEdit=function(t,a){e._valueChanged(a.latex())},this.visualMath.$input.hide()),t&&this.lastLatex&&(this.visualMath.field.latex(this.lastLatex),this._valueChanged(this.lastLatex)),t&&this.debug&&this._initDebug()},n.prototype._restoreLatex=function(){return this.lastLatex=this.$latexInput.val()?this.$latexInput.val():this.latexresponse,""===this.$stackInput.val()||""!==this.lastLatex},n.prototype._addEventHandlers=function(){var t=this;this.$stackInput.on("valchange",null,null,function(e,a){t.valueChanged(a)}),this.$stackInput.on("valerror",null,null,function(e,a){t.inputError(a),t.$stackInput.val("")})},n.prototype.cancelErrorDelay=function(){this.delayTimeoutHandle&&(clearTimeout(this.delayTimeoutHandle),this.validationOverlay.getUnderlay().removeClass("waiting")),this.delayTimeoutHandle=null},n.prototype._errorDelay=function(t){this.cancelErrorDelay(),this.validationOverlay.getUnderlay().addClass("waiting"),this.delayTimeoutHandle=setTimeout(function(){t()},this.TYPINGDELAY)},n.prototype._valueChanged=function(t){var e=this;if(this.cancelErrorDelay(),""===t)return this.$stackInput.trigger("valchange",[""]),this.lastLatex=t,this.$latexInput.val(t),void(this.debug&&this.$stackInput.trigger("valchangedebug",["",t]));try{var a=this.converter.toMaxima(t);this.lastMaximaRes=a,this.$stackInput.trigger("valchange",[a]),this.debug&&this.$stackInput.trigger("valchangedebug",[a,t])}catch(a){this.lastMaximaRes=a.message,this._errorDelay(function(){e.$stackInput.trigger("valerror",[a.message])}),this.debug&&this.$stackInput.trigger("valchangedebug",[a.message,t])}finally{this.lastLatex=t,this.$latexInput.val(t)}},n.prototype._formatOptionsObj=function(e){var a={};for(var i in e)if(e.hasOwnProperty(i)){var s=e[i];switch(i){case"insertStars":a.onlySingleVariables=2===s||5===s,a.addTimesSign=1===s||2===s||4===s||5===s}}return a=t.extend(this.DEFAULT_TEX2MAX_OPTIONS,a)},n.prototype._initDebug=function(){var a=this;e.get_strings([{key:"convertedmaximadebugging",component:"qtype_stack"},{key:"mathquilllatexdebugging",component:"qtype_stack"}]).then(function(e){a.$debugFeedback=a._createDebugFeedback(e),a.validationOverlay.getUnderlay().next(".stackinputfeedback").addBack().wrapAll("<div>"),a.validationOverlay.getUnderlay().parent().after(a.$debugFeedback);var i=t("#"+t.escapeSelector(a.prefix+a.name)+"_debug"),s=t("#"+t.escapeSelector(a.prefix+a.name)+"_latex_debug");i.html(a.lastMaximaRes),s.html(a.lastLatex),a.$stackInput.on("valchangedebug",null,null,function(t,e,a){i.html(e),s.html(a)})})},n.prototype._createDebugFeedback=function(e){var a=t("<div>").attr({class:"stackinputfeedbackdebug"}),i=t("<p>");i.append(e[0]);var s=t("<div>").attr({class:"stackdebugvalue",id:this.prefix+this.name+"_debug"}),n=t("<p>");n.append(e[1]);var r=t("<div>").attr({class:"stackdebugvalue",id:this.prefix+this.name+"_latex_debug"});return a.append(i,s,n,r),a},n});