define(["jquery","core/str","qtype_stack/tex2max.amd","qtype_stack/visual-math-input","qtype_stack/editor"],function(t,e,a,i,s){"use strict";var n=function(t,e,a,i,n){s.call(this,t,e,a,i,n),this.MQInputs={},this.controls=null,this.lastFocusedInput={input:null},this._init()};(n.prototype=Object.create(s.prototype)).constructor=n,n.prototype.EDITOR_NAME="WYSIWYG",n.prototype._init=function(){this.isReadonly()||this._buildInputControls(this.editorOptions.mathinputmode),this._setupInputs()},n.prototype._setupInputs=function(){for(var t=0;t<this.inputs.length;t++){var e=this.inputs[t].input,a=this.inputs[t].latexresponse,i=this.inputs[t].inputoptions,s=new l(this.prefix,e,a,i,this.getValidationOverlay(e),this.lastFocusedInput,this.debug);this.MQInputs[e]=s,s._addEventHandlers(this)}},n.prototype._buildInputControls=function(t){if(!t)throw new Error("No mathinputmode is set");this.controls=new i.ControlList("#"+this.questionid+"controls_wrapper",this.lastFocusedInput);var e=[];switch(t){case"simple":e=["sqrt","divide","pi","caret"],this.controls.enable(e);break;case"normal":e=["sqrt","divide","nchoosek","pi","caret"],this.controls.enable(e);break;case"advanced":this.controls.enableAll()}};var l=function(e,a,i,s,n,l,r){this.prefix=e,this.name=a,this.latexresponse=i,this.inputoptions=this._formatOptionsObj(s),this.validationOverlay=n,this.lastFocusedInput=l,this.debug=r,this.delayTimeoutHandle=null,this.readonly=null,this.converter=null,this.visualMath=null,this.$debugFeedback=null,this.$stackInput=t("#"+t.escapeSelector(this.prefix+this.name)),this.$latexInput=t("#"+t.escapeSelector(this.prefix+this.name)+"_latex"),this.lastMaximaRes=this.$stackInput.val(),this.lastLatex=this.$latexInput.val()?this.$latexInput.val():this.latexresponse,this._initTeX2Max(),this._initMathQuill()};return l.prototype.DEFAULT_TEX2MAX_OPTIONS={onlySingleVariables:!1,handleEquation:!1,addTimesSign:!0,onlyGreekName:!0,onlyGreekSymbol:!1,debugging:!1},l.prototype.TYPINGDELAY=1e3,l.prototype._initTeX2Max=function(){try{this.converter=new a(this.inputoptions)}catch(t){this.$stackInput.trigger("valerror",[t.message])}},l.prototype._initMathQuill=function(){this.$stackInput.wrap("<div>");var t=this.$stackInput.parent(),e=this._restoreLatex(),a=this;this._isReadonly()?e&&(this.visualMath=new i.StaticInput(this.$stackInput,t),this.visualMath.$input.hide()):(this.visualMath=new i.Input(this.$stackInput,t,this.lastFocusedInput),a.visualMath.onEdit=function(t,e){a._valueChanged(e.latex())},this.visualMath.$input.hide()),e&&this.lastLatex&&(this.visualMath.field.latex(this.lastLatex),this._valueChanged(this.lastLatex)),e&&this.debug&&this._initDebug()},l.prototype._restoreLatex=function(){return this.lastLatex=this.$latexInput.val()?this.$latexInput.val():this.latexresponse,""===this.$stackInput.val()||""!==this.lastLatex},l.prototype._isReadonly=function(){return null!=this.readonly?this.readonly:(this.readonly=this.$stackInput.prop("readonly"),this.readonly)},l.prototype._addEventHandlers=function(t){var e=this;this.$stackInput.on("valchange",null,null,function(a,i){t.valueChanged(e.name,i)}),this.$stackInput.on("valerror",null,null,function(a,i){t.inputError(e.name,i),e.$stackInput.val("")})},l.prototype.cancelErrorDelay=function(){this.delayTimeoutHandle&&(clearTimeout(this.delayTimeoutHandle),this.validationOverlay.getUnderlay().removeClass("waiting")),this.delayTimeoutHandle=null},l.prototype._errorDelay=function(t){this.cancelErrorDelay(),this.validationOverlay.getUnderlay().addClass("waiting"),this.delayTimeoutHandle=setTimeout(function(){t()},this.TYPINGDELAY)},l.prototype._valueChanged=function(t){var e=this;if(this.cancelErrorDelay(),""===t)return this.$stackInput.trigger("valchange",[""]),this.lastLatex=t,this.$latexInput.val(t),void(this.debug&&this.$stackInput.trigger("valchangedebug",["",t]));try{var a=this.converter.toMaxima(t);this.lastMaximaRes=a,this.$stackInput.trigger("valchange",[a]),this.debug&&this.$stackInput.trigger("valchangedebug",[a,t])}catch(a){this.lastMaximaRes=a.message,this._errorDelay(function(){e.$stackInput.trigger("valerror",[a.message])}),this.debug&&this.$stackInput.trigger("valchangedebug",[a.message,t])}finally{this.lastLatex=t,this.$latexInput.val(t)}},l.prototype._formatOptionsObj=function(e){var a={};for(var i in e)if(e.hasOwnProperty(i)){var s=e[i];switch(i){case"insertStars":a.onlySingleVariables=2===s||5===s,a.addTimesSign=1===s||2===s||4===s||5===s}}return a=t.extend(this.DEFAULT_TEX2MAX_OPTIONS,a)},l.prototype._initDebug=function(){var a=this;e.get_strings([{key:"convertedmaximadebugging",component:"qtype_stack"},{key:"mathquilllatexdebugging",component:"qtype_stack"}]).then(function(e){a.$debugFeedback=a._createDebugFeedback(e),a.validationOverlay.getUnderlay().next(".stackinputfeedback").addBack().wrapAll("<div>"),a.validationOverlay.getUnderlay().parent().after(a.$debugFeedback);var i=t("#"+t.escapeSelector(a.prefix+a.name)+"_debug"),s=t("#"+t.escapeSelector(a.prefix+a.name)+"_latex_debug");i.html(a.lastMaximaRes),s.html(a.lastLatex),a.$stackInput.on("valchangedebug",null,null,function(t,e,a){i.html(e),s.html(a)})})},l.prototype._createDebugFeedback=function(e){var a=t("<div>").attr({class:"stackinputfeedbackdebug"}),i=t("<p>");i.append(e[0]);var s=t("<div>").attr({class:"stackdebugvalue",id:this.prefix+this.name+"_debug"}),n=t("<p>");n.append(e[1]);var l=t("<div>").attr({class:"stackdebugvalue",id:this.prefix+this.name+"_latex_debug"});return a.append(i,s,n,l),a},n});