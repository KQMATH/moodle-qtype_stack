define(["jquery","qtype_stack/tex2max","qtype_stack/visual-math-input"],function(e,t,i){const s=1e3,n=1e3,l={onlySingleVariables:!1,handleEquation:!1,addTimesSign:!0,onlyGreekName:!0,onlyGreekSymbol:!1,debugging:!1};function r(e,t){let i;if(sessionStorage.getItem("editor_selection")){let s=sessionStorage.getItem("editor_selection");i=JSON.parse(s);let n=!1;for(let s in i)i.hasOwnProperty(s)&&s==e&&(n=!0,i[s]=t);n||(i[e]=t)}else(i={})[e]=t;sessionStorage.setItem("editor_selection",JSON.stringify(i))}return{initialize:(o,a,d,h,c,u,m)=>{if(!h.length>0)return;new class{constructor(e,t,i,s,n,l,r){this.errorTimer,this.waitingTimer,this.editorVisible=!0,this.inputs=[],this.controls=null,this.converters=new Map,this.questionid=e,this.prefix=i,this.stackInputIDs=s,this.latexInputIDs=n,this.latexResponses=l,this.questionOptions=r,this.debug=t,this.initialize()}initialize(){this.addEventListeners();let t=function(e){let t=null;if(sessionStorage.getItem("editor_selection")){let i=sessionStorage.getItem("editor_selection"),s=JSON.parse(i);for(let i in s)s.hasOwnProperty(i)&&i===e&&(t=s[i]);null===t&&(t=!1)}else t=null;return t}(this.questionid);this.editorVisible=null===t||t,r(this.questionid,this.editorVisible);let s=this.formatOptionsObj(this.questionOptions),n=!1;this.showOrHideCheckButton(this.stackInputIDs,this.prefix);for(let t=0;t<this.stackInputIDs.length;t++){let l,r,o=document.getElementById(this.latexInputIDs[t]),a=e(o),d=document.getElementById(this.stackInputIDs[t]),h=e(d),c=document.createElement("div");h.wrap(c);let u=h.parent();if(this.debug){let i=document.getElementById(this.stackInputIDs[t]+"_debug");l=e(i);let s=document.getElementById(this.latexInputIDs[t]+"_debug");r=e(s)}let m=new i.Input("#"+e.escapeSelector(this.stackInputIDs[t]),u);this.inputs.push(m),m.$input.hide(),m.$input.prop("readonly")?(n=!0,m.disable()):m.onEdit=((e,i)=>{e.val(this.convert(i.latex(),s,this.stackInputIDs[t])),a.val(i.latex()),e.get(0).dispatchEvent(new Event("change")),this.debug&&(l.html(this.convert(i.latex(),s,this.stackInputIDs[t])),r.html(i.latex()))}),a.val()?(m.field.write(a.val()),this.convert(a.val(),s,this.stackInputIDs[t])):null!==this.latexResponses[t]&&""!==this.latexResponses[t]&&(m.field.write(this.latexResponses[t]),this.convert(this.latexResponses[t],s,this.stackInputIDs[t]))}n?e("#"+this.questionid+"editor_selection").hide():this.buildInputControls(this.questionOptions.mathinputmode),this.editorVisible||(this.editorVisible=!0,this.toggleEditor(!1))}convert(i,s,n){let l="",r=this.converters.get(n);if(void 0===r)try{r=new t.TeX2Max(s),this.converters.set(n,r)}catch(e){return void this.renderErrorFeedback(e.message,n)}if(clearTimeout(this.errorTimer),!i){this.hideTeX2MaXFeedback(n);let t=document.getElementById(n+"_val");return e(t).hide(),l}try{l=r.toMaxima(i),this.hideTeX2MaXFeedback(n)}catch(e){this.renderErrorFeedback(e.message,n)}return l}removeAllValidationClasses(t){let i=document.getElementById(t),s=e(i);s.removeClass("empty"),s.removeClass("error"),s.removeClass("loading"),s.removeClass("waiting")}resetStackValidation(t){let i=document.getElementById(t+"_val");e(i).removeAttr("style")}hideTeX2MaXFeedback(t){let i=document.getElementById(t+"_tex2max"),s=e(i),l=this;""!==document.getElementById(t+"_val").style.display?(s.toggleClass("waiting",!0),l.waitingTimer=setTimeout(()=>{l.removeAllValidationClasses(t+"_tex2max"),s.toggleClass("empty",!0),l.resetStackValidation(t)},n),setTimeout(function(){l.removeAllValidationClasses(t+"_tex2max"),s.toggleClass("waiting",!0)},0)):s.toggleClass("empty",!0)}renderErrorFeedback(t,i){clearTimeout(this.waitingTimer);let n=document.getElementById(i+"_tex2max"),l=e(n);n&&!l.hasClass("empty")&&(this.removeAllValidationClasses(i+"_tex2max"),l.toggleClass("waiting",!0)),this.errorTimer=setTimeout(()=>{this.renderTeX2MaXFeedback(t,i)},s)}renderTeX2MaXFeedback(t,i){t||(t="");let s=document.getElementById(i+"_val"),n=e(s);if(n.hide(),document.getElementById(i+"_tex2max"))this.removeAllValidationClasses(i+"_tex2max"),document.getElementById(i+"_errormessage").innerHTML=t;else{let e=document.createElement("div");e.setAttribute("class","tex2max-feedback-wrapper"),e.setAttribute("id",i+"_tex2max");let s=document.createElement("p"),l=document.createElement("p");l.setAttribute("id",i+"_errormessage"),s.innerHTML="This answer is invalid.",l.innerHTML=t,e.append(s),e.append(l),n.after(e)}}showOrHideCheckButton(t,i){for(let s=0;s<t.length;s++){let n=e(document.getElementById(t[s])).parents("div.que.stack").first();if(n&&(n.hasClass("dfexplicitvaildate")||n.hasClass("dfcbmexplicitvaildate"))){let e=n.find(".im-controls input.submit").first();e.attr("id")===i+"-submit"&&e.hide()}}}formatOptionsObj(e){let t={};for(let i in e){if(!e.hasOwnProperty(i))continue;let s=e[i];switch(i){case"singlevars":t.onlySingleVariables="1"===s;break;case"addtimessign":t.addTimesSign="1"===s}}return t=Object.assign(l,t)}buildInputControls(e){if(!e)throw new Error("No mathinputmode is set");this.controls=new i.ControlList("#"+this.questionid+"controls_wrapper");let t=[];switch(e){case"simple":t=["sqrt","divide","pi","caret"],this.controls.enable(t);break;case"normal":t=["sqrt","divide","nchoosek","pi","caret"],this.controls.enable(t);break;case"experimental":this.controls.enableAll()}}addEventListeners(){let t=this;e("#"+this.questionid+"editor_selection").on("click",function(){t.toggleEditor(!0)})}toggleEditor(t){let i=document.getElementById(this.stackInputIDs[0]+"_debug"),s=e(i).closest(".stack-debug-wrapper");this.editorVisible?(this.inputs.forEach(e=>{e.$input.show(),e.wrapper.hide(),null!==this.controls&&this.controls.$wrapper.hide(),this.editorVisible=!1}),s.hide()):(this.inputs.forEach(e=>{e.$input.hide(),e.wrapper.show(),null!==this.controls&&this.controls.$wrapper.show(),this.editorVisible=!0}),s.show()),t&&r(this.questionid,this.editorVisible)}}(o,a,d,h,c,u,m)}}});