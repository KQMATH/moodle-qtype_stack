define(["jquery","qtype_stack/tex2max.amd","qtype_stack/visual-math-input"],function(e,t,i){const s=1e3,n=1e3,l={onlySingleVariables:!1,handleEquation:!1,addTimesSign:!0,onlyGreekName:!0,onlyGreekSymbol:!1,debugging:!1};function r(e,t){let i;if(sessionStorage.getItem("editor_selection")){let s=sessionStorage.getItem("editor_selection");i=JSON.parse(s);let n=!1;for(let s in i)i.hasOwnProperty(s)&&s==e&&(n=!0,i[s]=t);n||(i[e]=t)}else(i={})[e]=t;sessionStorage.setItem("editor_selection",JSON.stringify(i))}return{initialize:(o,a,d,h,u)=>{if(!h.length>0)return;new class{constructor(e,t,i,s,n){this.errorTimer,this.waitingTimer,this.editorVisible=!0,this.visualmathinput=[],this.controls=null,this.converters=new Map,this.questionid=e,this.prefix=i,this.inputs=s,this.editorOptions=n,this.debug=t,this.initialize()}initialize(){this.addEventListeners();let s=function(e){let t=null;if(sessionStorage.getItem("editor_selection")){let i=sessionStorage.getItem("editor_selection"),s=JSON.parse(i);for(let i in s)s.hasOwnProperty(i)&&i===e&&(t=s[i]);null===t&&(t=!1)}else t=null;return t}(this.questionid);this.editorVisible=null===s||s,r(this.questionid,this.editorVisible);let n=!1;this.showOrHideCheckButton(this.prefix);for(let s=0;s<this.inputs.length;s++){let l,r,o=this.inputs[s].inputid,a=this.inputs[s].latexinputid,d=this.inputs[s].latexresponse,h=this.formatOptionsObj(this.inputs[s].inputoptions),u=document.getElementById(a),m=e(u),c=document.getElementById(o),p=e(c),g=document.createElement("div");p.wrap(g);let b=p.parent();if(this.debug){let t=document.getElementById(o+"_debug");l=e(t);let i=document.getElementById(a+"_debug");r=e(i)}try{let e=new t(h);this.converters.set(o,e)}catch(e){return void this.renderErrorFeedback(e.message,o)}let v=new i.Input("#"+e.escapeSelector(o),b);this.visualmathinput.push(v),v.$input.hide(),v.$input.prop("readonly")?(n=!0,v.disable()):v.onEdit=((e,t)=>{e.val(this.convert(t.latex(),o)),m.val(t.latex()),e.get(0).dispatchEvent(new Event("change")),this.debug&&(l.html(this.convert(t.latex(),o)),r.html(t.latex()))}),m.val()?(v.field.write(m.val()),this.convert(m.val(),o)):null!==d&&""!==d&&(v.field.write(d),this.convert(d,o))}n?e("#"+this.questionid+"editor_selection").hide():this.buildInputControls(this.editorOptions.mathinputmode),this.editorVisible||(this.editorVisible=!0,this.toggleEditor(!1))}convert(t,i){let s="",n=this.converters.get(i);if(clearTimeout(this.errorTimer),!t){this.hideTeX2MaXFeedback(i);let t=document.getElementById(i+"_val");return e(t).hide(),s}try{s=n.toMaxima(t),this.hideTeX2MaXFeedback(i)}catch(e){this.renderErrorFeedback(e.message,i)}return s}removeAllValidationClasses(t){let i=document.getElementById(t),s=e(i);s.removeClass("empty"),s.removeClass("error"),s.removeClass("loading"),s.removeClass("waiting")}resetStackValidation(t){let i=document.getElementById(t+"_val");e(i).removeAttr("style")}hideTeX2MaXFeedback(t){let i=document.getElementById(t+"_tex2max"),s=e(i),l=this;""!==document.getElementById(t+"_val").style.display?(s.toggleClass("waiting",!0),l.waitingTimer=setTimeout(()=>{l.removeAllValidationClasses(t+"_tex2max"),s.toggleClass("empty",!0),l.resetStackValidation(t)},n),setTimeout(function(){l.removeAllValidationClasses(t+"_tex2max"),s.toggleClass("waiting",!0)},0)):s.toggleClass("empty",!0)}renderErrorFeedback(t,i){clearTimeout(this.waitingTimer);let n=document.getElementById(i+"_tex2max"),l=e(n);n&&!l.hasClass("empty")&&(this.removeAllValidationClasses(i+"_tex2max"),l.toggleClass("waiting",!0)),this.errorTimer=setTimeout(()=>{this.renderTeX2MaXFeedback(t,i)},s)}renderTeX2MaXFeedback(t,i){t||(t="");let s=document.getElementById(i+"_val"),n=e(s);if(n.hide(),document.getElementById(i+"_tex2max"))this.removeAllValidationClasses(i+"_tex2max"),document.getElementById(i+"_errormessage").innerHTML=t;else{let e=document.createElement("div");e.setAttribute("class","tex2max-feedback-wrapper"),e.setAttribute("id",i+"_tex2max");let s=document.createElement("p"),l=document.createElement("p");l.setAttribute("id",i+"_errormessage"),s.innerHTML="This answer is invalid.",l.innerHTML=t,e.append(s),e.append(l),n.after(e)}}showOrHideCheckButton(){for(let t=0;t<this.inputs.length;t++){let i=e(document.getElementById(this.inputs[t].inputid)).parents("div.que.stack").first();if(i&&(i.hasClass("dfexplicitvaildate")||i.hasClass("dfcbmexplicitvaildate"))){let e=i.find(".im-controls input.submit").first();e.attr("id")===this.prefix+"-submit"&&e.hide()}}}formatOptionsObj(e){let t={};for(let i in e){if(!e.hasOwnProperty(i))continue;let s=e[i];switch(i){case"insertStars":t.onlySingleVariables=2===s||5===s,t.addTimesSign=1===s||2===s||4===s||5===s}}return t=Object.assign(l,t)}buildInputControls(e){if(!e)throw new Error("No mathinputmode is set");this.controls=new i.ControlList("#"+this.questionid+"controls_wrapper");let t=[];switch(e){case"simple":t=["sqrt","divide","pi","caret"],this.controls.enable(t);break;case"normal":t=["sqrt","divide","nchoosek","pi","caret"],this.controls.enable(t);break;case"advanced":this.controls.enableAll()}}addEventListeners(){let t=this;e("#"+this.questionid+"editor_selection").on("click",function(){t.toggleEditor(!0)})}toggleEditor(t){let i=document.getElementById(this.inputs[0].inputid+"_debug"),s=e(i).closest(".stack-debug-wrapper");this.editorVisible?(this.visualmathinput.forEach(e=>{e.$input.show(),e.wrapper.hide(),null!==this.controls&&this.controls.$wrapper.hide(),this.editorVisible=!1}),s.hide()):(this.visualmathinput.forEach(e=>{e.$input.hide(),e.wrapper.show(),null!==this.controls&&this.controls.$wrapper.show(),this.editorVisible=!0}),s.show()),t&&r(this.questionid,this.editorVisible)}}(o,a,d,h,u)}}});